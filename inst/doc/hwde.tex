\documentclass[10pt,a4paper]{article}

\title{Testing and Modeling Genotypic Disequilibria}


%% \VignetteIndexEntry{hwde: An R Package for Tests and Models for Genotypic Disequilibria}
\usepackage{a4wide}
\newcommand{\keywords}[1]{\addvspace{\baselineskip}\noindent{{\bf Keywords.} #1}}

\usepackage{/Library/Frameworks/R.framework/Resources/share/texmf/Sweave}
\begin{document}
\author{John Maindonald\\
{\small Centre for Mathematics and Its Applications, Australian National 
University, Canberra, Australia}}
\date{}
\maketitle

\keywords{population genetics, Hardy-Weinberg, genotype, allele,
genotypic disequilibrium}

\section{Introduction}

In a diploid, sexually reproducing species, at a locus where there are
two alleles $A$ and $a$, the possible genotypes are $AA$, $Aa$ and
$aa$.  In a population of size $N$, with $p$ the frequency of the A
allele and $q$ the frequency of the a allele, the expected numbers
under Hardy-Weinberg equilibrium are $NP_{AA} = Np^2$ for the $AA$
genotype, $NP_{Aa} = 2Npq$ for the $Aa$ genotype, and $NP_{aa} = Nq^2$
for the $aa$ genotype.  Writing $m$ = $\log(Np^2)$ and $\log(q/p) =
m_a$, the logarithms of the frequencies may be written:
\begin{eqnarray}
\log(Np^{2})  &=&  m \\
\log(2Npq) &=&  m + \log(2) + m_a\\
\log(Nq^{2})  &=&  m + 2 m_a
\end{eqnarray}
Thus the model is loglinear, and can be fitted as a generalized linear
model with poisson error and offset $\log(2)$ for the heterozygote.
For example:
\begin{Schunk}
\begin{Sinput}
> obs <- c(AA = 147, Aa = 78, aa = 17)
> oset <- c(0, log(2), 0)
> ma <- c(0, 1, 2)
> hw.glm <- glm(obs ~ ma, family = poisson, offset = oset)
> summary(hw.glm)
\end{Sinput}
\begin{Soutput}
Call:
glm(formula = obs ~ ma, family = poisson, offset = oset)

Deviance Residuals: 
     AA       Aa       aa  
 0.3364  -0.8854   1.0708  

Coefficients:
            Estimate Std. Error z value Pr(>|z|)
(Intercept)  4.96256    0.08137   60.99   <2e-16
ma          -1.20039    0.10778  -11.14   <2e-16

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 149.3527  on 2  degrees of freedom
Residual deviance:   2.0436  on 1  degrees of freedom
AIC: 23.751

Number of Fisher Scoring iterations: 4
\end{Soutput}
\end{Schunk}

The function \texttt{hwde()} may also be used to fit this model, at the
same time introducing a further ``disequilibrium'' term. The default 
output is the analysis of deviance table.
\begin{Schunk}
\begin{Sinput}
> hwdat <- data.frame(Observed = c(147, 78, 17), locus1 = c("AA", 
+     "Aa", "aa"))
\end{Sinput}
\end{Schunk}
Now call the function.
\begin{Schunk}
\begin{Sinput}
> library(hwde)
> hwde(data = hwdat)
\end{Sinput}
\begin{Soutput}
[1] "Analysis of Deviance Table"
    Resid. Df Resid. Dev Df Deviance
1           2    149.353            
+a          1      2.044  1  147.309
+aa         0  8.216e-15  1    2.044
\end{Soutput}
\end{Schunk}
The disequilibrium term has the form
\[ m_{aa} = \log \frac{4 P_{AA} P_{aa}}{P_{Aa}^²}
\]
Notice that the parameters $m_a$ and $m_{aa}$ have been abbreviated,
in the computer output, to $a$ and $aa$ respectively. The parameter
$m$ models the reference or baseline level, and is estimated by the
intercept term.

To obtain estimates of parameters, including the disequilibrium parameter $m_{aa}$,
one can to the following:
\begin{Schunk}
\begin{Sinput}
> data.df <- hwde(data = hwdat)$data.df
\end{Sinput}
\begin{Soutput}
[1] "Analysis of Deviance Table"
    Resid. Df Resid. Dev Df Deviance
1           2    149.353            
+a          1      2.044  1  147.309
+aa         0  8.216e-15  1    2.044
\end{Soutput}
\begin{Sinput}
> names(data.df)
\end{Sinput}
\begin{Soutput}
[1] "obs"  "data" "oset" "a"    "aa"  
\end{Soutput}
\begin{Sinput}
> summary(glm(obs ~ a + aa, offset = oset, family = poisson, data = data.df))$coef
\end{Sinput}
\begin{Soutput}
             Estimate Std. Error  z value     Pr(>|z|)
(Intercept) 1.8332133  0.2425356 7.558532 4.076429e-14
a           0.5234955  0.2676640 1.955793 5.048954e-02
aa          1.1102283  0.3419186 3.247055 1.166060e-03
\end{Soutput}
\end{Schunk}
Note again that the intercept estimates $m$, and that $aa$ is the 

We leave till later detailed information on the use of \texttt{hwde()},
including details on how to obtain fitted values and residuals. 

\subsection{Several different populations}

If there several different populations, there must be a parameter
(by default assumed to have the name \texttt{Population}),
that accounts for different population sizes.  In the code, this
translates to a main effect \texttt{gp} in the log-linear model.
Additionally, there may be different values for $m_a$ and $m_{aa}$ in
the different populations.

A second locus requires the parameters $m_b$ and $m_{bb}$ for that
locus.  Additionally, parameters may be required that model quantities
that, in the loglinear model, have the role of interactions between
the two loci.  Huttley and Wilson (2000) introduce the multiplicative
versions of the following parameters:
\begin{itemize}
\item[] $s_{ab}$, the ``sum of digenic disequilibria for the
total sample''
\item[] $q_{ab}$, the ``product of digenic disequilibria for the
total sample''
\item[] $m_{aab}$ and $m_{abb}$, which are ``trigenic disequilibria terms
for the total sample''
\end{itemize}
In the usual case where phase for double heterozygotes is unknown and
only nine genotypic classes can be distinguished, no degrees of
freedom remain that might be used to estimate a quadrigenic
disequilibrium term.

As noted above, the formulae in Huttley and Wilson (2000) give the
multiplicative equivalents of these terms, using upper case letters.
The additive versions used here (e.g., they have $M_A$ where I have
$m_a = \log(M_A)$) use the corresponding lower case letters.  Note
however that in the second column on p.2131 of Huttley and Wilson, in
the equations for $\ln P_{Ab}^{AB}$ and $\ln P_{aB}^{AB}$, $\ln
Q_{AB}^2$ should be, in each case, $\ln Q_{AB}$.  The equations are
given correctly in Weir and Wilson (1986), though with slight changes
of notation. See also Weir (1996).

The function allows an arbitrary number of loci.  Terms $s_{ab}$,
$q_{ab}$, $m_{abb}$ and $m_{aab}$ are fitted for every pair of loci.
Terms that correspond to second (or, with $>$ 3 loci, higher order)
interactions contribute, in the present version of the code, to the
residual.  Try
\begin{Schunk}
\begin{Sinput}
> hwde(data = mendelABC, loci = c("seedshape", "cotylcolor", "coatcolor"))
\end{Sinput}
\end{Schunk}

\section{Details of Use of \texttt{hwde()}}

First recall the simple example that was described above.  The data
were entered, from the keyboard, into a data frame \texttt{hwdat} that
had the form:
\begin{verbatim}
Observed locus1
147      AA
78       Aa
17       aa
\end{verbatim}
The coding used in the column headed \texttt{locus1} can be varied;
any two characters may be used for the alleles.  With the column
names that are shown, the corresponding parameter settings for the function
\texttt{hwde()} can be left at their defaults.

An alternative is to enter the data, exactly as displayed above
(though the spacing is immaterial), into a file.  If the file is
called \textbf{hw.txt} and is placed in the working directory, then it
can be read in with:
\begin{Schunk}
\begin{Sinput}
> hwdat <- read.table("hw.txt", header = TRUE)
\end{Sinput}
\end{Schunk}

If there is a second locus, the default name is \texttt{locus2}.  The
default name for any third locus is \texttt{locus3}, etc.  Where there
is a column that has codes for different populations, the default name
is \texttt{Population}.

\subsubsection*{Example -- two populations and two loci}
With this introduction, we move directly to data, with two populations
and two loci, that are suited to fitting all the parameters that the
function currently allows, i.e., $m_{aa}$, $m_{bb}$, $m_{cc}$,
$s_{ab}$, $s_{ac}$, $s_{bc}$, $q_{ab}$, $q_{ac}$, $q_{bc}$,
$m_{abb}$, $m_{acc}$, $m_{bcc}$,
$m_{aab}$, $m_{aac}$, $m_{bbc}$.

Data (Mourant et al, 1976) are:
\begin{verbatim}
   Population locus1 locus2 Observed
     Indian     MM     SS       91
     Indian     MM     Ss      147
     Indian     MM     ss       85
     Indian     MN     SS       32
     Indian     MN     Ss       78
     Indian     MN     ss       75
     Indian     NN     SS        5
     Indian     NN     Ss       17
     Indian     NN     ss        7
      Irish     MM     SS      121
      Irish     MM     Ss      248
      Irish     MM     ss      164
      Irish     MN     SS       53
      Irish     MN     Ss      422
      Irish     MN     ss      375
      Irish     NN     SS        9
      Irish     NN     Ss       65
      Irish     NN     ss      241
\end{verbatim}

Assuming that this is stored in a file \textbf{IndianIrish.txt},
we can read in the data and do the analysis thus:
\begin{Schunk}
\begin{Sinput}
> IndianIrish <- read.table("IndianIrish.txt", header = TRUE)
\end{Sinput}
\end{Schunk}
\begin{Schunk}
\begin{Sinput}
> hwde(data = IndianIrish)
\end{Sinput}
\begin{Soutput}
[1] "Analysis of Deviance Table"
              Resid. Df Resid. Dev Df Deviance
1                    17    1724.07            
+gp                  16    1090.41  1   633.66
+(a+b)               14     486.72  2   603.69
+(aa+bb)             12     480.31  2     6.41
+sab                 11     463.76  1    16.55
+qab                 10     218.42  1   245.34
+(abb+aab)            8     217.15  2     1.28
+gp:(a+b)             6      37.94  2   179.21
+gp:(aa+bb)           4      35.46  2     2.48
+gp:sab               3      26.29  1     9.16
+gp:qab               2       5.94  1    20.36
+gp:(abb+aab)         0  4.663e-15  2     5.94
\end{Soutput}
\end{Schunk}

The above is the compact default output, in which terms that are at
the same level of a hierarchy are grouped.  For a first pass through
the data, this may be the preferred output.  A form of output in
which each term correspods to a single degree of freedom is available
by using the parameter setting \texttt{group.terms=FALSE}, i.e., 
\begin{Schunk}
\begin{Sinput}
> hwde(data = IndianIrish, group.terms = FALSE)
\end{Sinput}
\end{Schunk}
difference from the last previous Residual Deviance term that is
marked with an \texttt{r} (= reference) as the first character in the
row in which it appears.

The estimates of parameters in the maximal (or, with appropriate modification, any
other) model can be extracted thus:
\begin{Schunk}
\begin{Sinput}
> II.hwde <- hwde(data = mendelABC, loci = c("seedshape", "cotylcolor", 
+     "coatcolor"), keep.models = T)
\end{Sinput}
\begin{Soutput}
[1] "Analysis of Deviance Table"
                           Resid. Df Resid. Dev Df Deviance
1                                 26    210.254            
+(a+b+c)                          23    137.281  3   72.973
+(aa+bb+cc)                       20    115.573  3   21.708
+(sab+sac+sbc)                    17    105.059  3   10.514
+(qab+qac+qbc)                    14     55.494  3   49.565
+(abb+acc+bcc+aab+aac+bbc)         8     10.789  6   44.705
\end{Soutput}
\begin{Sinput}
> models <- II.hwde$models
> maxmodel <- models[[length(models)]]
> summary(maxmodel)$coef
\end{Sinput}
\begin{Soutput}
                Estimate Std. Error     z value     Pr(>|z|)
(Intercept)  1.683549334  0.2797590  6.01785643 1.767418e-09
a            0.325993165  0.2582278  1.26242477 2.067960e-01
b            0.813807815  0.2774041  2.93365419 3.349972e-03
c            0.469251656  0.2918309  1.60795759 1.078445e-01
aa          -1.028403908  0.4521094 -2.27467929 2.292518e-02
bb          -0.885063427  0.4105598 -2.15574771 3.110337e-02
cc           1.148348950  0.4152134  2.76568396 5.680356e-03
sab         -0.366288148  0.2135609 -1.71514616 8.631843e-02
sac         -0.071914559  0.2364631 -0.30412597 7.610319e-01
sbc         -0.620736851  0.2696044 -2.30239907 2.131268e-02
qab         -0.439121685  0.3317499 -1.32365261 1.856184e-01
qac         -0.579313263  0.3521036 -1.64529222 9.990956e-02
qbc         -0.876931995  0.3949857 -2.22016153 2.640780e-02
abb          0.009330965  0.2136682  0.04367035 9.651672e-01
acc         -0.926198223  0.2178926 -4.25071022 2.130937e-05
bcc         -0.031865444  0.2267383 -0.14053840 8.882346e-01
aab          0.570390292  0.2256474  2.52779494 1.147814e-02
aac          0.843177772  0.2249129  3.74890848 1.776059e-04
bbc          0.380047882  0.2154273  1.76415833 7.770533e-02
\end{Soutput}
\end{Schunk}

\section{Obtaining Additional Output}
By default, the function returns (invisibly) a list with two elements.
The first holds the analysis of variance table.  The second holds the
data and contrast terms that are required for fitting tbe various
models.  For example:
\begin{Schunk}
\begin{Sinput}
> hwdat.hw <- hwde(data = hwdat)
\end{Sinput}
\begin{Soutput}
[1] "Analysis of Deviance Table"
    Resid. Df Resid. Dev Df Deviance
1           2    149.353            
+a          1      2.044  1  147.309
+aa         0  8.216e-15  1    2.044
\end{Soutput}
\begin{Sinput}
> names(hwdat)
\end{Sinput}
\begin{Soutput}
[1] "Observed" "locus1"  
\end{Soutput}
\begin{Sinput}
> hwdat.hw$data.df
\end{Sinput}
\begin{Soutput}
  obs data oset a aa
1 147   AA    1 2  1
2  78   Aa    2 1  0
3  17   aa    1 0  0
\end{Soutput}
\end{Schunk}
The following illustrates the direct use of the information in 
\verb!hwdat.hw$data.df!, giving the user complete control over the
models that are fitted.
\begin{Schunk}
\begin{Sinput}
> data.df <- hwdat.hw$data.df
> model1 <- glm(obs ~ a, family = poisson, data = data.df, offset = log(oset))
> model2 <- glm(obs ~ a + aa, family = poisson, data = data.df, 
+     offset = log(oset))
> model1
\end{Sinput}
\begin{Soutput}
Call:  glm(formula = obs ~ a, family = poisson, data = data.df, offset = log(oset)) 

Coefficients:
(Intercept)            a  
      2.562        1.200  

Degrees of Freedom: 2 Total (i.e. Null);  1 Residual
Null Deviance:	    149.4 
Residual Deviance: 2.044 	AIC: 23.75 
\end{Soutput}
\end{Schunk}

Here is the output data frame for the \texttt{IndianIrish} data.
\begin{Schunk}
\begin{Sinput}
> II.hw <- hwde(data = IndianIrish, aovtable.print = FALSE)
> dataII.df <- II.hw$data.df
> dataII.df
\end{Sinput}
\begin{Soutput}
   obs     gp locus1 locus2 oset a b aa bb sab qab abb aab
1   91 Indian     MM     SS    1 2 2  1  1   0   2   2   2
2  147 Indian     MM     Ss    2 2 1  1  0   0   1   0   1
3   85 Indian     MM     ss    1 2 0  1  0   0   0   0   0
4   32 Indian     MN     SS    2 1 2  0  1   0   1   1   0
5   78 Indian     MN     Ss    4 1 1  0  0   1   0   0   0
6   75 Indian     MN     ss    2 1 0  0  0   0   0   0   0
7    5 Indian     NN     SS    1 0 2  0  1   0   0   0   0
8   17 Indian     NN     Ss    2 0 1  0  0   0   0   0   0
9    7 Indian     NN     ss    1 0 0  0  0   0   0   0   0
10 121  Irish     MM     SS    1 2 2  1  1   0   2   2   2
11 248  Irish     MM     Ss    2 2 1  1  0   0   1   0   1
12 164  Irish     MM     ss    1 2 0  1  0   0   0   0   0
13  53  Irish     MN     SS    2 1 2  0  1   0   1   1   0
14 422  Irish     MN     Ss    4 1 1  0  0   1   0   0   0
15 375  Irish     MN     ss    2 1 0  0  0   0   0   0   0
16   9  Irish     NN     SS    1 0 2  0  1   0   0   0   0
17  65  Irish     NN     Ss    2 0 1  0  0   0   0   0   0
18 241  Irish     NN     ss    1 0 0  0  0   0   0   0   0
\end{Soutput}
\end{Schunk}
The user can now fit any sequence of models that may be required.
For example, the user may wish to a sequence of models that is
different from the sequence fitted by \texttt{hwde()}.

Further control is available by supplying values for the parameters
\texttt{termlist} and \texttt{refmodel}.  For example, the default
action with the data frame \texttt{hwdat} is equivalent to:
\begin{Schunk}
\begin{Sinput}
> hwde(termlist = c("+a", "+aa"), refmodel = c(1, 2), data = hwdat)
\end{Sinput}
\begin{Soutput}
[1] "Analysis of Deviance Table"
    Resid. Df Resid. Dev Df Deviance
1           2    149.353            
+a          1      2.044  1  147.309
+aa         0  8.216e-15  1    2.044
\end{Soutput}
\end{Schunk}
In \texttt{refmodel}, 1 refers to the model that has constant term only.

The first six models can be fitted to the data frame \texttt{IndianIrish}
by setting:
\begin{Schunk}
\begin{Sinput}
> hwde(termlist = c("+gp", "+a", "+b", "+a+b", "+aa"), refmodel = c(1, 
+     2, 2, 2, 5), data = IndianIrish)
\end{Sinput}
\begin{Soutput}
[1] "Analysis of Deviance Table"
     Resid. Df Resid. Dev Df Deviance
1           17    1724.07            
+gp         16    1090.41  1   633.66
+a          15     853.73  1   236.68
+b          15     723.40  1   367.02
+a+b        14     486.72  2   603.69
+aa         13     485.59  1     1.13
\end{Soutput}
\end{Schunk}


\subsection*{Extraction of the sequence of fitted models}
A further possibility, with the parameter setting \texttt{keep.models=TRUE},
is to include the full sequence of models that have been fitted in the
list that is returned by the function.  For example:
\begin{Schunk}
\begin{Sinput}
> hwdat.hw <- hwde(data = hwdat, keep.models = TRUE)
\end{Sinput}
\begin{Soutput}
[1] "Analysis of Deviance Table"
    Resid. Df Resid. Dev Df Deviance
1           2    149.353            
+a          1      2.044  1  147.309
+aa         0  8.216e-15  1    2.044
\end{Soutput}
\begin{Sinput}
> hwdat.hw$models[[2]]
\end{Sinput}
\begin{Soutput}
Call:  glm(formula = obs ~ a, family = poisson, data = data.df, offset = log(oset)) 

Coefficients:
(Intercept)            a  
      2.562        1.200  

Degrees of Freedom: 2 Total (i.e. Null);  1 Residual
Null Deviance:	    149.4 
Residual Deviance: 2.044 	AIC: 23.75 
\end{Soutput}
\begin{Sinput}
> fitted(hwdat.hw$models[[2]])
\end{Sinput}
\begin{Soutput}
        1         2         3 
142.95868  86.08264  12.95868 
\end{Soutput}
\end{Schunk}
The function \texttt{fitted()} can be replaced by any of the
functions (\texttt{coef()}, \texttt{resid()}, \texttt{predict()},
etc.) that are available for use with a \texttt{glm} model object.
Note that there are several different choices of residuals, with 
deviance residuals as the default.  For the \texttt{IndianIrish}
data there are, with the parameter setting \texttt{group.terms=FALSE}, 
24 models from which to choose.  Choose carefully!

\section{Exact Hardy-Weinberg Test}
The function \texttt{hwexact()}, supplied by Randall Johnson, does an
exact test for Hardy-Weinberg equilibrium, conditional on the observed
relative numbers of the two alleles.  The only case implemented is for
a single population and single locus.  The algorithm is described in
Wigginton et al (2005).

\section{References}
\begin{itemize}
\item[] Huttley, G.A. and Wilson, S.R. 2000. Testing for concordant
equilibria between population samples.  Genetics 156: 2127-2135.
\item[] Mourant, A.E., Kopec, A.C. and Domaniewska-Sobczak, K. 1976.
\textit{The Distribution of the Human Blood Groups and Other Polymorphisms.}
Oxford University Press.
\item[] Weir, B.S. 1996.  \textit{Genetic Data Analysis II.} Sinauer.
\item[] Weir, B.S. and Wilson, S.R. 1986.  Log-linear models for
linked loci. Biometrics 42:665-670.
\item[] Wigginton, J.E., Cutler, D.J. and Abecasis, G.R. 2000. A note on
  exact tests of Hardy-Weinberg equilibrium. \textit{American Journal of Human
  Genetics} 76: 887-893.
\end{itemize}

\end{document}


